#!/usr/bin/env coffee

HOST = 'http://localhost:3000/'
# HOST = 'http://echotron.info/'

UglifyJS = require 'uglify-js'
request = require 'request'
path = require 'path'
fs   = require 'fs'
argv = require('optimist').argv

lib  = path.join path.dirname(fs.realpathSync(__filename)), '../lib'

layerCompiler = require path.join(lib, 'layer')
manifest = require path.join(lib, 'manifest')

[command, options...] = argv._

switch command
  when undefined, 'server'
    app = require path.join(lib, '/server')
    port = options[0] || 3001

    console.log "Started server at http://localhost:#{port}/"
    app.listen port

  when 'publish'
    [type, name] = options
    layers = []

    if type && name
      echoes = ["#{type}/#{name}"]
    else
      manifest.findLayers (err, layerPaths) -> layers = layerPaths
    
    for layerPath in layers
      do (layerPath, type, name) ->
        [type, name] = layerPath.split('/')
        # meta = layerCompiler.compileMeta type, name
        # meta.content = layerCompiler.compile type, name
        code = layerCompiler.compile type, name
        code = UglifyJS.minify(code, fromString: yes).code

        request.post "#{HOST}layers.js", json: { layer: { code, location: type, name } }, (err, res, body) ->
          console.log "Uploaded: #{type} #{name}"